# Copyright (c) 2026, Alexei Znamensky (@russoz)
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)
# SPDX-License-Identifier: GPL-3.0-or-later

---
- name: "Get current sysctl value"
  community.openwrt.command:
    cmd: sysctl -n net.ipv4.ip_forward
  register: current_value

- name: "Set a sysctl parameter"
  community.openwrt.sysctl:
    name: net.ipv4.ip_forward
    value: 0

- name: "Set a sysctl parameter"
  community.openwrt.sysctl:
    name: net.ipv4.ip_forward
    value: 1
  register: sysctl_result

- name: Assert sysctl changed
  ansible.builtin.assert:
    that:
      - sysctl_result is changed

- name: "Verify the sysctl value was set"
  community.openwrt.command:
    cmd: sysctl -n net.ipv4.ip_forward
  register: new_value

- name: Assert sysctl value matches
  ansible.builtin.assert:
    that:
      - new_value.stdout == "1"

- name: "Revert to original value"
  community.openwrt.sysctl:
    name: net.ipv4.ip_forward
    value: "{{ current_value.stdout }}"
    sysctl_file: /etc/sysctl.conf

- name: Tests persisting sysctl setting in sysctl.conf file
  vars:
    sysctl_file: /etc/sysctl.conf
    sysctl_setting_name: fs.file-max
    sysctl_setting_value: 396480
  block:
    - name: Set `fs.file-max` with sysctl
      community.openwrt.sysctl:
        sysctl_file: "{{ sysctl_file }}"
        state: present
        name: "{{ sysctl_setting_name }}"
        value: "{{ sysctl_setting_value }}"

    - name: Check sysctl setting exists
      community.openwrt.lineinfile:
        path: "{{ sysctl_file }}"
        line: "{{ sysctl_setting_name }}={{ sysctl_setting_value }}"
      check_mode: true
      register: sysctl_setting_check

    - name: Assert sysctl setting exists
      ansible.builtin.assert:
        that:
          - sysctl_setting_check.changed == false

    - name: Clean up - remove `fs.file-max` with sysctl
      community.openwrt.sysctl:
        sysctl_file: "{{ sysctl_file }}"
        state: absent
        name: "{{ sysctl_setting_name }}"

    - name: Check sysctl setting absent
      community.openwrt.lineinfile:
        path: "{{ sysctl_file }}"
        line: "{{ sysctl_setting_name }}={{ sysctl_setting_value }}"
        state: absent
      check_mode: true
      register: sysctl_setting_check

    - name: Assert sysctl setting absent
      ansible.builtin.assert:
        that:
          - sysctl_setting_check.changed == false
